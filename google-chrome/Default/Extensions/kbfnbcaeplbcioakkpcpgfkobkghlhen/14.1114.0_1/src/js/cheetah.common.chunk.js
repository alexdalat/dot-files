(self.webpackChunk=self.webpackChunk||[]).push([[4382],{47335:(e,t,i)=>{i.r(t),i.d(t,{CheetahFeatureImpl:()=>He});var s=i(17771),n=i(17889),a=i(62965),o=i(75668),r=i(85892),l=i(57050),c=i(27378),h=i(8482),d=i(74850),u=i(5817),p=i(14601),g=i(32952),m=i(24209),_=i(85985),v=i(23063),b=i(66310),S=i(50628),f=i(40151),w=i(98403),y=i(2844),R=i(77176),E=i(2834),I=i(76974),C=i(28043),U=i(41398),k=i(93508),A=i(16118),x=i(13444),P=i(78674),B=i(60797),G=i(17343),M=i(80544),z=i(79692),O=i(67434),N=i(19751),T=i(44586),F=i(97425),q=i(5114),H=i(8125),D=i(83078),W=i(22232),V=i(95195),Z=i(95574),L=i(12187),Q=i(38983),Y=i(34217),j=i(76518),K=i.n(j);const $=({width:e,height:t,top:i,left:s})=>c.createElement("div",{"data-grammarly-part":"cheetah-highlight-rect",className:K().highlightRect,style:{width:e,height:t,top:i,left:s}});var X=i(20855),J=i(98917);const ee=c.forwardRef((function({forceTooltipMessage:e,onClick:t,onMouseEnter:i,onMouseLeave:s},n){return c.createElement(X.u,{message:"Open GrammarlyGO",forcedMessage:e},c.createElement("button",{onClick:t,"data-grammarly-part":"cheetah-ideate-button",className:J.ideateButton,ref:n,onMouseEnter:i,onMouseLeave:s},c.createElement("div",{className:J.ideateButtonIcon})))}));var te=i(98685),ie=i(86620),se=i(92132),ne=i(49468),ae=i(89894),oe=i(33678),re=i(15073),le=i(42103),ce=i(51369);const he=ae.ux.style({fontStyle:"normal",fontWeight:"normal",fontFamily:"Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif, Arial",$nest:{"button, input, textarea":{fontFamily:"inherit"}}}),de=({env:e,children:t})=>c.createElement(ne.o,null,c.createElement(oe.a.Context.Provider,{value:new ie.C(e)},c.createElement(se.Q,{remSize:I.of(16),setter:e=>re.u.setRootCssVar(document.documentElement,e)},c.createElement(le.G.DefaultProvider,null,c.createElement("div",{className:he},t,c.createElement(ce.X,null))))));var ue=i(74204),pe=i(95229);const ge=({referenceElement:e,placement:t,offset:i,disabled:s,onClick:n})=>{const[a,o]=c.useState(null),{styles:r,attributes:l}=(0,ue.D)(e,a,{placement:t,modifiers:i?[{name:"offset",options:{offset:i}}]:[]});return c.createElement("button",{ref:o,style:r.popper,...l.popper,onClick:n,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},"data-grammarly-part":"cheetah-reply-button",className:pe.replyButton,"data-disabled":s},c.createElement("div",{className:pe.icon}),c.createElement("span",null,"Reply quickly"))};var me=i(68566);const _e=({referenceElement:e,placement:t,offset:i,disabled:s,onMagicRewriteClick:n,onOpenRewriteClick:a})=>{const[o,r]=c.useState(null),{styles:l,attributes:h}=(0,ue.D)(e,o,{placement:t,modifiers:i?[{name:"offset",options:{offset:i}}]:[]});return n||a?c.createElement("div",{ref:r,style:l.popper,...h.popper,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},"data-grammarly-part":"cheetah-entry-button",className:me.entryButton,"data-disabled":s},n?c.createElement(X.u,{message:"Improve it"},c.createElement("button",{onClick:n,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},className:me.entryButtonItem,"data-disabled":s},c.createElement("i",{className:me.rewriteIcon}))):null,a?c.createElement(X.u,{message:"Open GrammarlyGO"},c.createElement("button",{onClick:a,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},className:me.entryButtonItem,"data-disabled":s},c.createElement("i",{className:me.openIcon}))):null):null};var ve=i(90845),be=i(49708),Se=i(5739),fe=i(7131);const we=()=>c.createElement("svg",{className:fe.icon,viewBox:"0 0 16 16",fillRule:"evenodd",clipRule:"evenodd",strokeLinecap:"round"},c.createElement("path",{d:"M8,16C12.418,16 16,12.418 16,8C16,3.582 12.418,0 8,0C3.582,0 0,3.582 0,8C0,12.418 3.582,16 8,16Z",fill:"#0A9A78"}),c.createElement("path",{d:"M4,8L12,8M8,4L8,12",fill:"none",fillRule:"nonzero",stroke:"white",strokeWidth:"1.5px"})),ye=({overflow:e,...t})=>e?c.createElement(Ee,{...t}):c.createElement(Re,{...t}),Re=({left:e,top:t,height:i})=>c.createElement(c.Fragment,null,c.createElement("div",{"data-grammarly-part":"cheetah-quasi-caret",className:fe.quasiCaret,style:{left:e,top:t+i,height:i+8}},c.createElement(we,null))),Ee=({left:e,top:t,height:i})=>{const{ref:n,onMount:a}=ve.P.useElWatcher(),o=c.useMemo((()=>Q.h.create(q.none)),[]),{rect:r,onMount:h}=ve.P.useRectWatcher(),d=c.useCallback((e=>{e.style.pointerEvents="all",o.set((0,l.zG)(s.Y(q.option)({rect:q.some(e.getBoundingClientRect()),goodParent:(0,l.zG)(e.getBoundingClientRect(),(e=>({x:e.x+e.width/2,y:e.y+e.height/2})),(({x:e,y:t})=>{var i,s;return q.fromNullable(null===(s=null===(i=document.elementFromPoint(e,t))||void 0===i?void 0:i.shadowRoot)||void 0===s?void 0:s.elementFromPoint(e,t))}),q.filter((t=>t===e||e.contains(t||null))))}),q.fold((()=>q.none),(({rect:e})=>q.some({x:e.x,y:e.y}))))),e.style.pointerEvents="none"}),[]),u=c.useMemo((()=>be.R(document,"scroll",{capture:!0}).pipe(k.O(null))),[]);return ve.P.useSubscriptionTo(y.aj([n.pipe(B.oA),u,r]).pipe(E.b((([e])=>d(e))))),c.createElement(c.Fragment,null,c.createElement("div",{"data-grammarly-part":"cheetah-quasi-caret",className:fe.quasiCaret,style:{left:e,top:t+i,height:i+8},ref:e=>{a(e),h(e)}},c.createElement(Se.F.div,{style:o.pipe(R.U((e=>(0,l.zG)(e,q.fold((()=>({opacity:1})),(()=>({opacity:0})))))))},c.createElement(we,null))),c.createElement(Se.F.Fragment,null,o.pipe(R.U((e=>(0,l.zG)(e,q.fold(l.gn,(e=>c.createElement("div",{"data-grammarly-part":"cheetah-quasi-caret-fixed-bro",className:fe.quasiCaret,style:{transform:"none",position:"fixed",left:e.x,top:e.y,height:i+8}},c.createElement(we,null))))))))))};var Ie=i(95572),Ce=i(64015),Ue=i(55073),ke=i(32264),Ae=i(93962),xe=i(4120),Pe=i(39464),Be=i(70288),Ge=i(62111);var Me=i(23423),ze=i(81531),Oe=i(30732),Ne=i(36582);const Te=(0,L.xb)(ee),Fe=new Set(["onboarding","gdocsOnboardingPopup","loginSSO","accountMigration","standWithUkraineGrammarlySuspended","claimedUser","dataControl","noPaymentMethodSubscription","grammarlyBusinessSigninPopup","gdocsFeedbackUI"]),qe=new Set(["onboarding","gdocsOnboardingPopup","loginSSO","accountMigration","standWithUkraineGrammarlySuspended","claimedUser","dataControl","grammarlyBusinessSigninPopup"]);class He{constructor(e,t,i,s,n,r,c,h,u,C,U,k,A,x,P,B,G){this._integration=e,this._textChangeBuffer=t,this._checkingService=i,this._textStats=s,this._csPageState=n,this._cheetahCSActions=r,this._dapiActions=c,this._dapiSettings=h,this._closeGrammarlyAssistant=u,this._getEnv=C,this._featureFlags=U,this._user=k,this._gButtonPopupState=A,this._gButtonDisabledReason=x,this._sessionStartedAvailabilityInfo=P,this._domain=B,this._gnar=G,this._subs=new p.w,this._log=d.Y.create("CheetahFeatureImpl"),this._inlineButtonUI=Q.h.create(null),this._ideateButtonUI=Q.h.create(null),this._expandedIdeateButtonUI=Q.h.create(null),this._assistantUI=Q.h.create(null),this._highlightUI=Q.h.create(null),this._quasiCaretUI=Q.h.create(null),this._onboardingUI=Q.h.create(null),this._nativeCursorHider=Q.h.create(q.none),this._lastRestartAttemptTime=Q.h.create(0),this.inlineButtonUI=this._inlineButtonUI.view(),this.ideateButtonUI=this._ideateButtonUI.view(),this.expandedIdeateButtonUI=this._expandedIdeateButtonUI.view(),this.assistantUI=this._assistantUI.view(),this.highlightUI=this._highlightUI.view(),this.quasiCaretUI=this._quasiCaretUI.view(),this.onboardingUI=this._onboardingUI.view(),this._ideateButtonTooltipNotificationState=Q.h.create(q.none),this._capiEvents=new g.xQ,this._assistantFocused=Q.h.create(!1),this._inlineButtonRecentlyPressed=Q.h.create(!1),this._ideateButtonRecentlyHovered=Q.h.create(!1),this._selectionRange=Q.h.create(q.none),this._highlightRects=Q.h.create([]),this._quasiCaretRect=Q.h.create(q.none),this._assistantSession=Q.h.create(q.none),this._onboardingViewModel=Q.h.create(q.none),this._ideateButtonRefChange=new g.xQ,this._disposed=new g.xQ,this._initialOnboardingBlockedForSession=Q.h.create(!1),this._cheetahServices=function(e,t,i,s,n,r,c,h,d,u,m,S,f,w,C,U,k,A,x,P,B){const G=new g.xQ,H=()=>(0,l.zG)(e.get(),V.fromOption((()=>new Error("checking service not initialized")))),D={capiEvents:t,cheetahStartSession:e=>(0,l.zG)(H(),V.chain((t=>Z.tryCatchError((()=>t.cheetahStartSession(e))))),a.Uo),cheetahSetVoice:e=>(0,l.zG)(H(),V.chain((t=>Z.tryCatchError((()=>t.cheetahSetVoice(e))))),a.Uo),cheetahSetVoiceProfile:e=>(0,l.zG)(H(),V.chain((t=>Z.tryCatchError((()=>t.cheetahSetVoiceProfile(e))))),a.Uo),cheetahSearchReferences:e=>(0,l.zG)(H(),V.chain((t=>Z.tryCatchError((()=>t.cheetahSearchReferences(e))))),a.Uo),cheetahAction:e=>(0,l.zG)(H(),V.chain((t=>Z.tryCatchError((()=>t.cheetahAction(e))))),a.Uo),cheetahInterrupt:e=>(0,l.zG)(H(),V.chain((t=>Z.tryCatchError((()=>t.cheetahInterrupt(e))))),a.Uo),cheetahEndSession:()=>(0,l.zG)(H(),V.chain((e=>Z.tryCatchError((()=>e.cheetahEndSession())))),a.Uo),sendUserAction:(e,t)=>(0,l.zG)(H(),V.chain((i=>Z.tryCatchError((()=>i.sendUserAction(e,t))))),a.Uo),setContext:e=>(0,l.zG)(H(),V.chain((t=>Z.tryCatchError((()=>t.setContext(e))))),a.Uo),submitSurvey:(...e)=>(0,l.zG)(H(),V.chain((t=>Z.tryCatchError((()=>t.submitSurvey(...e))))),a.Uo)},L=new ke.c3(D),Y={user:Q.h.combine(i,s,((e,t)=>({isPremium:xe.n5.isPremium(e),dialect:t}))),setDialect:n},j=new ke.$C(D,h),K=r.pipe(b.w(q.fold((()=>I.of(q.none)),(e=>e.sessionService.session.view(q.some))))),$=d.pipe(M.QV(z.E),O.R(((e,t)=>{const i=e.filter(Ve);return t&&Ve(t)?[...i,t]:i}),[]),R.U(Ce.Z$),N.shareReplay({bufferSize:1,refCount:!0})),X=y.aj([$,u,m]).pipe(R.U((([e,t,i])=>(0,l.zG)(e,q.filter((()=>t)),q.fold((()=>({})),(e=>({[Ae.nF.initialPopupAnchor]:i?{reference:e,placement:"top",offset:8,boundaryAreaPadding:10}:void 0,[Ae.nF.rewriteTooltipAnchor]:{reference:e,placement:"top",offset:8,boundaryAreaPadding:10}}))))))),J=r.pipe(b.w(q.fold((()=>I.of(!1)),(e=>e.viewModels.position.state.view((e=>"dragged"===e.kind&&e.dragging)))))),ee=e=>{null==B||B.debug(`Completing step [${e}]`);f.get()[e].extension.completed||w({[e]:{completed:!0,lastSeen:Date.now()}})},te={reportUphookShow:e=>a.tD((()=>{e.isPremium||((0,Me.n)(P,{placement:"grammarlyGoPrompts",upgradeHookName:"grammarlyGoPrompts",upgradeHookSlot:"grammarlyGo"}),(0,Ge.Tb)().upgradeHooks.showUpgradeHook("grammarlyGoPrompts","grammarlyGo"))})),reportUphookClick:e=>a.tD((()=>{e.isPremium?self.open(o.Rd().appConfig.url.support):((0,Me.Q)(P,{placement:"grammarlyGoPrompts",upgradeHookName:"grammarlyGoPrompts",upgradeHookSlot:"grammarlyGo"}),(0,Ge.Tb)().upgradeHooks.clickUpgradeHook("grammarlyGoPrompts","grammarlyGo"),(0,Pe.wW)("upHook","grammarlyGoPrompts"))}))};return{capiService:D,userService:Y,availabilityService:j,trackingService:L,textEditorService:{flush:()=>a.fF((()=>new T.y((t=>{const i=new p.w;return k.empty.get()?t.next(void 0):(k.flush(),(0,l.zG)(e.get(),q.fold((()=>t.next(void 0)),(e=>{i.add(e.messages.pipe(_.h((e=>e._tag===Ie.J8.Type.submitOtAck)),F.L(500,I.of(null)),E.b((()=>t.next(void 0)))).subscribe())})))),()=>i.unsubscribe()})).pipe(v.q(1)).toPromise())),getText:e=>a.tD((()=>A(e))),insertText:e=>a.tD((()=>x(e)))},feedbackService:{submitFeedback:e=>a.Y3((()=>P.feedbackFormSubmit(e.mood,e.source===Ae.x2.Source.resultCard?"cheetah-card":e.source===Ae.x2.Source.quickReplyInitialActions?"cheetah-quick-reply":(0,W.L0)(e.source),e.domain,e.message)),(e=>new Error(String(e))))},uphookService:te,createOnboardingViewModel:()=>{const e=new Set;return C.get().rewrite&&U||e.add(Ae.TG.StepName.rewrite),C.get().compose||e.add(Ae.TG.StepName.initial),C.get().onboarding||(e.add(Ae.TG.StepName.initial),e.add(Ae.TG.StepName.rewrite),e.add(Ae.TG.StepName.prompts),e.add(Ae.TG.StepName.review),e.add(Ae.TG.StepName.knowledgeHub)),C.get().knowledgeHubIntegration||e.add(Ae.TG.StepName.knowledgeHub),(0,Be.kF)({upstreamOnboardingState:f,session:K,textStats:c,forceDisabledOnboardingSteps:e,assistantUIActions:G,externalElements:X,hideAssistantOnboardingTooltips:J,promptsAllocated:j.promptsAllocated,client:"extension",trackingService:L,disposed:S,logger:ze.C8.Logging.getLogger("OnboardingCompletionEffects"),completeOnboardingStep:ee})},notifyAssistantUIAction:e=>G.next(e),dispose:()=>j.dispose()}}(this._checkingService,this._capiEvents,this._user,this._dapiSettings.view((e=>e.dialectStrong?Ae.LA.Dialect.Value.fromString(e.dialectStrong):e.dialectWeak?Ae.LA.Dialect.Value.fromString(e.dialectWeak):Ae.LA.Dialect.Value.american)),(e=>a.fF((()=>this._dapiActions.changeStrongDialect(e)))),this._assistantSession,this._textStats,this._sessionStartedAvailabilityInfo,this._ideateButtonRefChange,Q.h.combine(this._integration.canShowIdeateButtonPopups,this._gButtonPopupState.view("type").view((e=>!Fe.has(e))),H.xD),Q.h.combine(this._csPageState.view("cheetah").view((e=>(null==e?void 0:e.canShowInitialOnboarding)||!1)),this._initialOnboardingBlockedForSession,((e,t)=>e&&!t)),m.T(this._csPageState.view("isActiveTab").pipe(_.h((e=>!e))),this._disposed).pipe(v.q(1)),this._dapiSettings.view((e=>function(e){const t=Ae.Zq.State.toClientState(Ae.Zq.decode(e.extension||""),"extension"),i=Ae.Zq.State.toClientState(Ae.Zq.decode(e.editor||""),"editor"),s=Ae.Zq.State.toClientState(Ae.Zq.decode(e.llamaMac||""),"llamaMac"),n=Ae.Zq.State.toClientState(Ae.Zq.decode(e.llamaWindows||""),"llamaWin");return(0,l.zG)(Ae.Zq.State.empty,Ae.Zq.State.patch(t,"extension"),Ae.Zq.State.patch(i,"editor"),Ae.Zq.State.patch(s,"llamaMac"),Ae.Zq.State.patch(n,"llamaWin"))}({extension:e["cheetah:onboardingState"],editor:e["cheetah:onboardingState:editor"],llamaMac:e["cheetah:onboardingState:llamaMac"],llamaWindows:e["cheetah:onboardingState:llamaWindows"]}))),(e=>{this._dapiActions.modifyCheetahOnboardingState((0,l.ls)(Ae.Zq.decode,(t=>(0,l.zG)(Ae.Zq.State.toClientState(t,"extension"),(t=>({...t,...e})),(e=>Ae.Zq.State.patch(e,"extension")(t)))),Ae.Zq.encode))}),this._featureFlags,this._integration.enableInlineRewrites,this._textChangeBuffer,(e=>this._integration.getText(e)),(e=>this._insertText(e)),this._gnar,this._log),this._isOnboardingPopupVisible=Q.h.create(!1),this._entryPointsEnabled=Q.h.create(!1),this.isAssistantOpened=this._assistantSession.view(q.isSome),this.isOnboardingPopupVisible=this._isOnboardingPopupVisible.view(),this.isCheetahAvailable=Q.h.combine(this._cheetahServices.availabilityService.availability.view((0,H.ff)(Ae.a8.isUnavailable)),this._csPageState.view("cheetah"),((e,t)=>{var i;return e&&!0===(null===(i=null==t?void 0:t.status)||void 0===i?void 0:i.cheetahEnabled)})),this._dapiActions.reloadPropsRateLimited(),this._subs.add(this._checkingService.pipe(_.h(q.isSome),b.w((e=>e.value.readyState)),_.h((e=>e===Ie.kQ.ready)),S.P()).subscribe((()=>this._init()))),this._subs.add(this._listenToMonitoringEvents()),this._subs.add(this._setupIdeateTooltipStateObs()),this._subs.add(this._onboardingViewModel.pipe(b.w(q.fold((()=>f.E),(e=>e.uiActions))),_.h(Le)).subscribe((()=>{this._cheetahCSActions.cheetahInitialOnboardingShown()}))),this._subs.add(this._getOnboardingVMStepActive(Ae.TG.StepName.initial).subscribe(w.wW(this._isOnboardingPopupVisible))),this._subs.add(this._gButtonPopupState.view("type").view((e=>qe.has(e))).subscribe((e=>{e&&this._initialOnboardingBlockedForSession.set(!0)}))),this._subs.add(y.aj([this._gButtonDisabledReason,this._integration.entryPointsEnabled]).pipe(R.U((([e,t])=>t&&!function(e){const t=new Set([Oe.P.DATA_CONTROL_ACTIVE,Oe.P.OFFLINE,Oe.P.STAND_WITH_UKRAINE,Oe.P.USER_CLAIMED,Oe.P.USER_EDC_BLOCKED,Oe.P.SIGNED_OUT_GB]);return null!==e&&t.has(e)}(e)))).subscribe(w.wW(this._entryPointsEnabled))),this._subs.add(this._csPageState.view("cheetah").view((e=>{var t;return!1===(null===(t=null==e?void 0:e.status)||void 0===t?void 0:t.cheetahEnabled)})).subscribe((()=>this._terminateAssistantSession(Ae.z_.EndReason.disposed)))),this._registerDebugHelpers()}onCAPIEvent(e){this._capiEvents.next(e)}closeAssistant(e){this._terminateAssistantSession(e)}_init(){this._subs.add(this._assistantFocused.subscribe((e=>this._log.debug("Assistant "+(e?"focused":"blurred"))))),this._subs.add(this._getInlineButtonUI().subscribe(w.wW(this._inlineButtonUI))),this._subs.add(this._getIdeateButtonUI().subscribe(w.wW(this._ideateButtonUI))),this._subs.add(this._getExpandedIdeateButtonUI().subscribe(w.wW(this._expandedIdeateButtonUI))),this._subs.add(this._getAssistantUI().subscribe(w.wW(this._assistantUI))),this._subs.add(this._getHighlightUI().subscribe(w.wW(this._highlightUI))),this._subs.add(this._getQuasiCaretUI().subscribe(w.wW(this._quasiCaretUI))),this._subs.add(this._getOnboardingUI().subscribe(w.wW(this._onboardingUI))),this._subs.add(this._updateSelectionRange().subscribe(w.wW(this._selectionRange))),this._subs.add(this._updateHighlightRects().subscribe(w.wW(this._highlightRects))),this._subs.add(this._updateQuasiCaretRect().subscribe(w.wW(this._quasiCaretRect))),this._subs.add(this._updateNativeCursor().subscribe()),this._subs.add(this._closeRewriteAssistantWhenUnfocused().subscribe()),this._subs.add(this._assistantSession.view(q.isSome).subscribe((e=>{e&&this._closeGrammarlyAssistant()}))),this._subs.add(this._createOnboardingViewModelWhenCheetahAvailable().subscribe()),this._subs.add(this._handleTryItOut().subscribe())}_handleTryItOut(){return this._onboardingViewModel.pipe(b.w(q.fold((()=>f.E),(e=>e.uiActions))),_.h(Ae.lG.is(Ae.lG.Kind.tryItOut)),E.b((()=>this._startNewAssistantSession(De(this._integration.quickReplyContext.get())&&this._featureFlags.get().quickReply?Ae.z_.Mode.quickReply:Ae.z_.Mode.ideation))))}_getOnboardingVMStepActive(e){return this._onboardingViewModel.pipe(b.w(q.fold((()=>I.of(!1)),(t=>t.activeStep.view((0,l.ls)(q.filter((e=>e.show)),q.map((e=>e.name)),D.contains(e)))))),C.x())}_listenToMonitoringEvents(){return ke.gz.getInstance().events.pipe(U.M(this._checkingService)).subscribe((([e,t])=>{this._log.info("received monitoring event",{ev:e}),(0,l.zG)(t,D.tap((t=>{Ae._H.isError(e)?((0,Ge.Tb)().cheetah.error(e,this._domain,t.sessionUuid),e.name!==Ae.SA.Error.Name.waitForContextTimeout&&e.name!==Ae.SA.Error.Name.waitForAckTimeout||"startSession"!==e.command||(Date.now()-this._lastRestartAttemptTime.get()>u.LK(5)?(this._lastRestartAttemptTime.set(Date.now()),this._restartSession()):(0,Ge.Tb)().cheetah.sessionRestartTimeout(e.name===Ae.SA.Error.Name.waitForAckTimeout?"ack":e.name===Ae.SA.Error.Name.waitForContextTimeout?"setContext":(0,W.L0)(e),this._domain,t.sessionUuid))):Ae._H.isInfo(e)?(0,Ge.Tb)().cheetah.info(e,this._domain,t.sessionUuid):Ae._H.isWarning(e)?(0,Ge.Tb)().cheetah.warning(e,this._domain,t.sessionUuid):(0,W.L0)(e)})))}))}_setupIdeateTooltipStateObs(){return this._cheetahServices.availabilityService.availability.pipe(k.O(null),A.G(),R.U((([e,t])=>e&&t&&Ae.a8.isPassive(e)&&Ae.a8.isActive(t)?q.some("Youâ€™ve got prompts!"):q.none)),b.w(q.fold((()=>I.of(q.none)),(e=>m.T(I.of(q.some(e)),I.of(q.none).pipe(x.g(3e3))))))).subscribe(w.wW(this._ideateButtonTooltipNotificationState))}_registerDebugHelpers(){!function(e){const t=self;t&&(t.cheetahDebug=t.cheetahDebug||{},Object.assign(t.cheetahDebug,e))}({clearOnboarding:()=>this._dapiActions.modifyCheetahOnboardingState((()=>Ae.Zq.encode(Ae.Zq.State.empty)))})}_createOnboardingViewModelWhenCheetahAvailable(){return Q.h.combine(this._featureFlags,this._cheetahServices.availabilityService.availability.view(Ae.a8.isUsable),((e,t)=>e.onboarding&&t)).pipe(E.b((e=>this._onboardingViewModel.modify((t=>((0,l.zG)(t,D.tap((e=>e.dispose()))),e?q.some(this._cheetahServices.createOnboardingViewModel()):q.none))))))}_closeRewriteAssistantWhenUnfocused(){return this._assistantFocused.pipe(P.b(100),_.h((e=>!e&&(0,l.zG)(this._assistantSession.get(),q.fold(l.jv,(e=>e.sessionService.session.view((e=>"started"===e.kind&&Ae.z_.Mode.isRewriteOrQuickRewrite(e.mode)&&q.isNone(e.inProgressResult)&&0===e.resultHistory.length)).get()))))),E.b((()=>this._terminateAssistantSession(Ae.z_.EndReason.assistantBlurred))))}_onClickIdeateButton(e){q.isSome(this._assistantSession.get())?this._terminateAssistantSession(Ae.z_.EndReason.closed):this._startNewAssistantSession(e)}_updateSelectionRange(){return y.aj([this._integration.selectionRange,this._assistantUI.pipe(_.h((e=>null===e)))]).pipe(R.U((([e,t])=>({selectionRange:e,assistantIsFocused:this._assistantFocused.get(),inlineButtonRecentlyPressed:this._inlineButtonRecentlyPressed.get(),ideateButtonRecentlyHovered:this._ideateButtonRecentlyHovered.get(),initialPopupOnboardingStepIsActive:this.isOnboardingPopupVisible.get(),assistantIsHidden:t}))),E.b((({inlineButtonRecentlyPressed:e,ideateButtonRecentlyHovered:t})=>{e&&this._inlineButtonRecentlyPressed.set(!1),t&&this._ideateButtonRecentlyHovered.set(!1)})),_.h((({selectionRange:e,assistantIsFocused:t,inlineButtonRecentlyPressed:i,ideateButtonRecentlyHovered:s,initialPopupOnboardingStepIsActive:n,assistantIsHidden:a})=>!!a||!i&&!s&&(!q.isNone(e)||!t&&!n))),R.U((({selectionRange:e})=>e)))}_updateHighlightRects(){return this._selectionRange.pipe(b.w(q.fold((()=>I.of([])),(e=>this._integration.getHighlightRects(e)))))}_updateQuasiCaretRect(){return this._selectionRange.pipe(b.w((e=>(0,l.zG)(e,q.filter(h.SV.isCollapsed),q.fold((()=>I.of([])),(e=>this._integration.getHighlightRects(e)))))),R.U((e=>(0,l.zG)(e,n.c2,q.map((e=>e[e.length-1]))))))}_updateNativeCursor(){return Q.h.combine(this._quasiCaretRect,this._assistantSession.view(q.isSome),((e,t)=>(0,l.zG)(s.Y(q.option)({nativeUIHider:q.fromNullable(this._integration.createNativeUIHider),quasiCaretRect:e}),q.filter((()=>t)),D.tapLeft((()=>{this._nativeCursorHider.modify((e=>((0,l.zG)(e,D.tap((e=>e.dispose()))),q.none)))})),D.tap((({nativeUIHider:e})=>{this._nativeCursorHider.modify((t=>((0,l.zG)(t,D.tap((e=>e.dispose()))),q.some(e()))))})))))}_terminateAssistantSession(e){this._assistantSession.modify(q.chain((t=>(t.dispose(e),q.none)))),e!==Ae.z_.EndReason.closed&&e!==Ae.z_.EndReason.assistantBlurred||this._integration.focusTextField()}_restartSession(){this._log.info("reconnecting checking service and restarting session"),(0,l.zG)(this._assistantSession.get(),D.tap((e=>{const t=e.sessionService.session.get().mode;e.dispose(Ae.z_.EndReason.disposed),this._assistantSession.set(q.none),(0,l.zG)(this._checkingService.get(),D.tap((e=>{e.reconnect()}))),this._startNewAssistantSession(t)})))}_startNewAssistantSession(e){this._assistantFocused.set(!0);const t={disableKnowledgeEngine:"disabled"===this._dapiSettings.get().serengetiState||void 0},i=Ae.z_.Mode.isIdeation(e)?{mode:e,metadata:t}:Ae.z_.Mode.isRewriteOrQuickRewrite(e)?{mode:e,selectedRange:(0,l.zG)(this._selectionRange.get(),q.getOrElseW((()=>({start:0,end:0})))),metadata:t}:Ae.z_.Mode.isQuickReply(e)?{mode:e,quickReplyContext:(0,l.zG)(this._integration.quickReplyContext.get(),q.fold((()=>Ae.H3.empty),We)),metadata:t}:(0,W.vE)(e),s=new ke.ZP({startSessionOptions:i,textEditorService:this._cheetahServices.textEditorService,capiService:this._cheetahServices.capiService,userService:this._cheetahServices.userService,trackingService:this._cheetahServices.trackingService}),n=new Ne.p({capiService:this._cheetahServices.capiService}),o=te.TB.create({textEditorService:this._cheetahServices.textEditorService,userService:this._cheetahServices.userService,availabilityService:this._cheetahServices.availabilityService,trackingService:this._cheetahServices.trackingService,uphookService:this._cheetahServices.uphookService,feedbackService:this._cheetahServices.feedbackService,sessionService:s,userSurveyService:n,positionInfo:this._integration.assistantPlacement.pipe(B.oA),handlers:{onFocusChange:e=>this._assistantFocused.set(e),close:()=>a.tD((()=>this._terminateAssistantSession(Ae.z_.EndReason.closed)))}}),r=o.actions.subscribe((e=>this._cheetahServices.notifyAssistantUIAction(e))),c={sessionService:s,viewModels:o,dispose:e=>{r.unsubscribe(),s.dispose(e),n.dispose(),o.dispose(),this._assistantFocused.set(!1)}};this._assistantSession.set(q.some(c))}_getInlineButtonUI(){return(0,l.zG)(s.Y(r.P)({inlineButtonInfo:this._integration.inlineButtonPlacement,selectionRange:this._selectionRange,selectionOngoing:m.T(this._integration.selectionRange.pipe(R.U((e=>(0,l.zG)(e,q.isSome)))),this._integration.selectionRange.pipe(P.b(100),G.h(!1))),assistantClosed:this._assistantSession.view(q.isNone),textMapIsEmpty:this._integration.textMapIsEmpty,quickReplyContext:this._integration.quickReplyContext,availability:this._cheetahServices.availabilityService.availability,entryPointsEnabled:this._entryPointsEnabled,featureFlags:this._featureFlags})).pipe(R.U((({inlineButtonInfo:e,selectionRange:t,selectionOngoing:i,assistantClosed:s,textMapIsEmpty:n,quickReplyContext:a,availability:o,entryPointsEnabled:r,featureFlags:h})=>(0,l.zG)(e,q.filter((()=>r)),q.filter((()=>s)),q.filter((()=>Ae.a8.isUsable(o))),q.fold(l.gn,(e=>(0,l.zG)(t,q.fold(l.gn,(t=>n&&q.isSome(a)&&h.inlineQuickReply?c.createElement(ge,{disabled:!1,referenceElement:e.referenceElement,placement:e.placement,offset:q.toNullable(e.offset),onClick:()=>{this._inlineButtonRecentlyPressed.set(!0),this._startNewAssistantSession(Ae.z_.Mode.quickReply)}}):Ze(t)&&(h.inlineRewrite||h.magicRewrite)&&this._integration.enableInlineRewrites?c.createElement(_e,{disabled:i,referenceElement:e.referenceElement,placement:e.placement,offset:q.toNullable(e.offset),onOpenRewriteClick:h.inlineRewrite?()=>{this._inlineButtonRecentlyPressed.set(!0),this._startNewAssistantSession(Ae.z_.Mode.rewrite)}:void 0,onMagicRewriteClick:h.magicRewrite?()=>{this._inlineButtonRecentlyPressed.set(!0),this._startNewAssistantSession(Ae.z_.Mode.quickRewrite)}:void 0}):null)))))))))}_getAssistantUI(){return this._assistantSession.view(q.fold(l.gn,(e=>c.createElement(de,{env:this._getEnv()},Y.UI.mount((0,te.aK)(e.viewModels),(0,te.WY)(e.viewModels,{contentFlowOptions:{chatFlowOptions:{assistantMaxHeight:Q.h.create(q.none)},feedbackFormFlowOptions:{showDomainCheckbox:q.some(this._domain)}}}))))))}_getOnboardingUI(){return this._onboardingViewModel.view(q.fold(l.gn,(e=>c.createElement(de,{env:this._getEnv()},Y.UI.mount(Be.gy,(0,Be.Bx)(e))))))}_getHighlightUI(){return Q.h.combine(this._highlightRects,this._assistantSession.view(q.isSome),this._assistantFocused,((e,t,i)=>t&&i?e.map(((e,t)=>c.createElement($,{key:`cheetah-highlight-rect-${t}`,top:e.top,left:e.left,width:e.width,height:e.height}))):null))}_getQuasiCaretUI(){return Q.h.combine(this._quasiCaretRect,this._assistantSession.view(q.isSome),((e,t)=>(0,l.zG)(e,q.filter((()=>t)),q.fold((()=>null),(e=>c.createElement(ye,{left:e.left,top:e.top,height:e.height,overflow:this._integration.allowCustomCaretOverflow}))))))}_getIdeateButtonUI(){return Q.h.combine(this._featureFlags,this._inlineButtonUI,this._selectionRange,this._integration.quickReplyContext,this._cheetahServices.availabilityService.availability,this._entryPointsEnabled,((e,t,i,s,n,a)=>(0,l.zG)(t,q.fromPredicate((e=>null===e)),q.filter((()=>a&&e.ideateButton)),q.filter((()=>Ae.a8.isUsable(n))),q.fold(l.gn,(()=>this._getIdeateButtonForSelectionRange(i,s,e))))))}_getExpandedIdeateButtonUI(){return Q.h.combine(this._featureFlags,this._selectionRange,this._integration.quickReplyContext,this._cheetahServices.availabilityService.availability,this._entryPointsEnabled,((e,t,i,s,n)=>(0,l.zG)(s,q.fromPredicate((e=>Ae.a8.isVisible(e))),q.filter((()=>n&&e.ideateButton)),q.fold(l.gn,(()=>this._getIdeateButtonForSelectionRange(t,i,e))))))}_getIdeateButtonForSelectionRange(e,t,i){return(0,l.zG)(e,q.filter((e=>Ze(e)&&i.rewrite)),q.fold((()=>De(t)&&i.quickReply?Ae.z_.Mode.quickReply:i.compose?Ae.z_.Mode.ideation:null),(()=>Ae.z_.Mode.rewrite)),q.fromNullable,q.fold(l.gn,(e=>c.createElement(Te,{onMouseEnter:()=>this._ideateButtonRecentlyHovered.set(!0),onMouseLeave:()=>this._ideateButtonRecentlyHovered.set(!1),onClick:()=>this._onClickIdeateButton(e),mount:e=>this._ideateButtonRefChange.next(e),forceTooltipMessage:this._ideateButtonTooltipNotificationState.view(q.toUndefined)}))))}_insertText(e){""!==e?this._integration.insertText(e,this._selectionRange.get()):this._log.warn("insert() - attempting to insert empty response, skipping insert.")}dispose(){var e;this._disposed.next(null),this._terminateAssistantSession(Ae.z_.EndReason.disposed),null===(e=q.toUndefined(this._onboardingViewModel.get()))||void 0===e||e.dispose(),this._cheetahServices.dispose(),this._subs.unsubscribe(),(0,l.zG)(this._nativeCursorHider.get(),D.tap((e=>e.dispose()))),this._integration.dispose()}}function De(e){return(0,l.zG)(e,q.exists((e=>Object.values(e).filter((e=>void 0!==e)).length>0)))}function We(e){var t,i,s,n,a,o,r,c,h,d,u,p,g,m,_,v,b;const S=e=>{var t;return null!==(t=null==e?void 0:e.reduce(((e,t)=>{var i;return t.email&&!e.has(t.email)&&e.set(t.email,{name:null!==(i=t.name)&&void 0!==i?i:"",email:t.email}),e}),new Map))&&void 0!==t?t:new Map},f=S(null===(s=null===(i=null===(t=e.parents)||void 0===t?void 0:t[0])||void 0===i?void 0:i.audience)||void 0===s?void 0:s.indirectRecipients),w=S(null===(o=null===(a=null===(n=e.parents)||void 0===n?void 0:n[0])||void 0===a?void 0:a.audience)||void 0===o?void 0:o.undisclosedRecipients),y=S(null===(d=null===(h=null===(c=null===(r=e.parents)||void 0===r?void 0:r[0])||void 0===c?void 0:c.audience)||void 0===h?void 0:h.recipients)||void 0===d?void 0:d.filter((({email:e})=>void 0!==e&&!f.has(e)&&!w.has(e)))),R=S(null===(u=e.audience)||void 0===u?void 0:u.indirectRecipients),E=S(null===(p=e.audience)||void 0===p?void 0:p.undisclosedRecipients),I=S(null===(m=null===(g=e.audience)||void 0===g?void 0:g.recipients)||void 0===m?void 0:m.filter((({email:e})=>void 0!==e&&!R.has(e)&&!E.has(e))));return{previousMessageInfo:(0,l.zG)(Ce.YM(null!==(_=e.parents)&&void 0!==_?_:[]),q.fold((()=>Ae.H3.PreviousMessageInfo.empty),(e=>{var t;return{author:(0,l.zG)(Ce.YM(null!==(t=e.authors)&&void 0!==t?t:[]),q.fold((()=>Ae.H3.Person.empty),(e=>{var t,i;return{name:null!==(t=e.name)&&void 0!==t?t:"",email:null!==(i=e.email)&&void 0!==i?i:""}}))),directRecipients:Array.from(y.values()),text:e.delta?(0,Ue.l)(e.delta,""):""}}))),title:null!==(v=e.title)&&void 0!==v?v:"",author:(0,l.zG)(Ce.YM(null!==(b=e.authors)&&void 0!==b?b:[]),q.fold((()=>Ae.H3.Person.empty),(e=>{var t,i;return{name:null!==(t=e.name)&&void 0!==t?t:"",email:null!==(i=e.email)&&void 0!==i?i:""}}))),directRecipients:Array.from(I.values()),indirectRecipients:Array.from(R.values()),undisclosedRecipients:Array.from(E.values())}}function Ve(e){return e.isConnected&&null!==e.offsetParent}function Ze(e){const t=e.end-e.start;return t>=10&&t<5e3}function Le(e){return(0,H.W9)(Ae.lG.is(Ae.lG.Kind.mount),(e=>e.step===Ae.TG.StepName.initial))(e)}},92132:(e,t,i)=>{i.d(t,{Q:()=>l});var s=i(27378),n=i(15073),a=i(60797),o=i(95300),r=i(5114);const l=({children:e,remSize:t,setter:i})=>(c+=1,s.useEffect((()=>{const e=t.subscribe((e=>{h.next(r.some(e)),i(r.some(e))}));return()=>{e.unsubscribe(),c-=1,0===c&&(h.next(r.none),i(r.none))}}),[t]),s.createElement(n.u.Context.Provider,{value:h.pipe(a.oA)},e));let c=0;const h=new o.X(r.none)},76518:e=>{e.exports={highlightRect:"XWxTA"}},98917:e=>{e.exports={ideateButton:"_ErYR",ideateButtonIcon:"i8HXG",spin:"CSZH1"}},68566:e=>{e.exports={entryButton:"cDocn",entryButtonItem:"dJCJe",rewriteIcon:"wGNWN",openIcon:"vIUqu",spin:"A8MjA"}},95229:e=>{e.exports={replyButton:"ZfD1U",icon:"BdxRh",spin:"MBS28"}},7131:e=>{e.exports={quasiCaret:"WhbAl",icon:"Yd_W5"}}}]);